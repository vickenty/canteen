#!/bin/bash

uid=`id -u`
port=$((uid + 10000))
host=`hostname -f`
secrets=.canteen_secrets

set -e

if [ ! -f main.db ]; then
    echo "*********************"
    echo "Creating new database"
    echo "Log in using demo@example.test with empty password"
    echo "*********************"
    cat schema.sql demo.sql | sqlite3 main.db
fi

if [ ! -f $secrets ]; then
    (
        umask 077
        echo "# This file was autogenerated on `date`" > $secrets
        echo "SESSION_SECRET=`pwgen -snc 16 1`" >> $secrets
        echo "EMAIL_SECRET=`pwgen -snc 16 1`" >> $secrets
    )
fi

. $secrets

export SESSION_SECRET
export EMAIL_SECRET

export PERL5LIB=./lib:$PERL5LIB
export DATABASE=main.db
export DOMAIN=$host:$port
export SENDER="Canteen Dev ($USER) <$USER@$host>"

if [ "$1" = "" ]; then
    morbo -l http://$host:$port main.pl
else
    "$@"
fi
